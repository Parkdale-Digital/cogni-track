2025-09-29 – Step 1 fixtures captured for OpenAI Admin API (usage, projects, memberships, service accounts, keys, certificates).
2025-09-29 – Drafted OpenAI admin schema/migration design doc with FK graph, unique indexes, and review questions.
2025-09-29 – Added admin ingestion spike harness (`spikes/admin_ingestion_spike.ts`) and runbook to validate fixture replay + dedupe logic.
2025-09-29 – Documented OpenAI Admin security controls and integration guardrails (`docs/openai_admin_security_controls.md`, `memorybank/integrations.md`).
2025-09-29 – Refreshed `openai_admin_data_plan.md` with >=8/10 confidence scores, validation hooks, and rollout updates referencing new artefacts.
2025-09-29 – Archived admin ingestion spike report `audit/spike-results/admin_ingestion_spike.json` with summary notes.
2025-09-29 – Scheduled security (2025-10-01) and legal (2025-10-02) reviews; agendas in `/audit/security-review` and `/audit/legal-review`.
2025-09-29 – Authored draft migration `drizzle/0002_openai_admin_tables.sql` plus pre-check instructions (`audit/migration-prechecks.md`).
2025-09-29 – Prep work for spike execution and migration pre-checks documented (checklists in `audit/spike-results/ADMIN_INGESTION_SPIKE_NOTES.md` and `audit/migration-prechecks.md`).
2025-09-30 – Normalized spike harness timestamps to ISO strings (see `spikes/admin_ingestion_spike.ts`) to ensure dedupe collapses bucket + daily events.
2025-09-30 – Executed admin ingestion spike harness (`pnpm exec tsx spikes/admin_ingestion_spike.ts`); logged checksum `aa5edfacf6c747a554b38c85de3fce46f729b85f16940dbc281572b13ef11832` in `audit/spike-results/ADMIN_INGESTION_SPIKE_NOTES.md`.
2025-09-30 – Updated migration pre-check runbook to replace unsupported `drizzle-kit status` with supported commands.
2025-09-30 – Swapped Drizzle pre-check commands to `export` + `check` in `audit/migration-prechecks.md` after CLI verification.
2025-09-30 – Executed migration pre-checks checklist with audit artefacts under audit/migration-prechecks.
2025-09-30 – Elevated migration pre-check evidence with deterministic exports, duplicate spike runs, and checksum verification.
2025-09-30 – Added OpenAI admin tables to Drizzle schema and relations to align with migration draft.
2025-09-30 – Updated src/db/schema.ts with OpenAI admin tables and recorded migration diff parity.
2025-09-30 – Logged ingestion readiness gaps (fixture ID drift, pagination coverage, rate limiting) and captured remediation plan in `memorybank/ingestion_readiness_report.md`.
2025-09-30 – Added multi-page admin usage fixtures (`*_page2.json`) and updated spike harness to validate pagination + foreign key references.
2025-09-30 – Implemented admin usage throttle (`OPENAI_ADMIN_REQUESTS_PER_MINUTE`/`OPENAI_ADMIN_MAX_BURST`) and Retry-After aware fetch logic in `src/lib/usage-fetcher.ts`; updated spike harness + fixtures to cover pagination and FK checks.
2025-10-01 – Exercised admin throttle against mocked server (audit/mock_rate_limit.log) verifying Retry-After handling and burst capping.
2025-10-01 – Added per-day window + metadata columns to `usage_events` (`window_start`, cached token splits, project/key identifiers) and created migration `drizzle/0003_usage_event_windows.sql` updating `usage_admin_bucket_idx` to dedupe on `(key_id, model, window_start)`.
2025-10-01 – Extended `src/lib/usage-fetcher.ts` to populate new `usage_events` metadata: admin/standard fetchers assign `window_start/window_end`, capture OpenAI project/key/tier context, cached token splits, and dedupe on `(keyId, model, windowStart)` before inserts.
2025-10-01 – Converted ingestion dedupe to an upsert (update on existing rows) and tightened `usage_admin_bucket_idx` with a partial index to avoid NULL `window_start`; addressed reviewer feedback about redundant `batch` coalescing.
2025-10-01 – Snapshot regeneration pending; Drizzle tooling requires DATABASE_URL which is not available in sandbox. Documented TODO to rerun `pnpm drizzle-kit generate` in staging.
2025-10-01 – Added feature flag `ENABLE_DAILY_USAGE_WINDOWS`; `fetchAndStoreUsageForUser` now iterates per-day windows, aggregates telemetry (`updatedEvents`, `windowsProcessed`), and upserts each bucket with simulation fallback scoped per window.
2025-10-01 – Responded to PR review threads (window metadata upserts, telemetry increments, migration strategy) and clarified follow-ups; local `npm run build` showed no TypeScript errors post-fix.
2025-10-01 – Broadened `usage_admin_bucket_idx` uniqueness to cover project/api key/user/tier/batch metadata and switched ingestion writes to a single Drizzle `onConflictDoUpdate` upsert keyed on the named constraint.
2025-10-01 – Added dual completions fixture (`usage_completions_fixture_dual.json`) plus spike harness assertions so metadata-rich admin buckets survive dedupe; spike report now records the metadata buckets for audit.
2025-10-01 – Instrumented cron daily usage route with aggregated telemetry output (windows processed, simulated/failing key counts, issues-by-code) and logged flag state prior to execution.
2025-10-01 – Extended `fetchAndStoreUsageForUser` to accept explicit start/end window overrides and run labels for staged backfill control.
2025-10-01 – Added chunked backfill CLI (`scripts/usage-backfill.ts`) with `pnpm usage:backfill` entry for historical ingestion runs and telemetry logging.
2025-10-02 – Replaced Drizzle `onConflictDoUpdate` usage event upsert with raw `ON CONSTRAINT usage_admin_bucket_idx` SQL to avoid runtime `keyAsName` errors during backfills.
2025-10-02 – Logged staging rehearsal outcomes in `audit/backfill-rehearsal/README.md`, capturing initial failure and post-fix validation run.
2025-10-02 – Swapped raw upsert for insert+update fallback; detected staging Neon DB missing `window_start` column (migration `0003_usage_event_windows.sql`), blocking historical ingestion until schema is updated.
2025-10-02 – Applied migrations `0000`-`0003` against local Postgres via `drizzle-kit push` to validate schema readiness; local backfill rehearsal now blocked earlier by missing seeded OpenAI provider keys.
2025-10-02 – Refactored usage ingestion upsert to central helper with conflict-aware telemetry updates; daily window buckets now use normalized payload builder and upsert helper in `src/lib/usage-fetcher.ts`.
2025-10-02 – Refactored usage ingestion upsert to a helper with conflict-aware telemetry; normalized bucket payload builder now feeds `src/lib/usage-fetcher.ts` daily window loop.
2025-10-02 – Split usage_events migration into staged ALTER batches and extended unique index to include window_end, mirroring schema update in `src/db/schema.ts`.
2025-10-02 – Simplified usage fetcher helpers (parseDateInput messaging, optional number casting) and routed bucket upsert through shared constraint fallback using the named window_end-aware index.
2025-10-15 – Migrated daily usage cron runbook and OpenAPI spec into Docusaurus, added GitHub Pages deploy workflow (`.github/workflows/docs-deploy.yml`), configured PR previews, and updated `docs-site/docusaurus.config.ts` with GitHub Pages defaults.
2025-10-02 – Reworked analytics toggle controls with explicit labels and h3 hierarchy; ToggleGroup now supports aria-labelled roles to resolve PR accessibility feedback in `src/components/DataAggregation.tsx`.
2025-10-02 – Hardened usage ingestion upsert: detect SQLSTATE 42P10/42704 errors when `usage_admin_bucket_idx` is absent, log once, and fall back to manual dedupe to keep ingestion running.
2025-10-02 – Added constraint fallback regression tests (`tests/usageFetcherConstraintFallback.test.ts`) and bundled test runner to cover both cost alerts and ingestion dedupe cases.
2025-10-02 – Resolved drizzle.config.ts merge conflict; established env fallback chain (DRIZZLE_DATABASE_URL → LOCAL_DATABASE_URL → DATABASE_URL) and verified with `pnpm drizzle-kit check`.
2025-10-07 – Hardened `usage_admin_bucket_idx` handling in `src/lib/usage-fetcher.ts`, guarding against undefined constraint metadata and falling back to manual dedupe; validated by running `pnpm usage:backfill --start 2025-09-15 --end 2025-09-16 --chunk-days 1 --label debug-admin` (2 daily windows stored without DB errors).
2025-10-07 – Enabled `direnv` for the repo (`.envrc` + `.env.local`) so ingestion/backfill commands inherit OpenAI and database credentials automatically.
2025-10-07 – Compiled `scripts/usage-telemetry-diff.ts` via `esbuild` to bypass top-level await issues and executed dry-run/full staging diffs; archived outputs `audit/telemetry-audit/2025-10-07T22-44-11Z-dryrun.json` and `audit/telemetry-audit/2025-10-07T22-44-28Z-staging.json` with SHA256 `82c61d54326a363615fe257ee7e0ae1f778c6a7ba5ee28ebd93cb3245d18a019`.
2025-10-07 – Created telemetry diff prerequisites checklist (`memorybank/telemetry_diff_checklist.md`) covering credential verification, staging snapshot capture, instrumentation toggles, and synthetic dataset prep ahead of nightly monitoring.
2025-10-07 – Added persistence instrumentation counters in `src/lib/usage-fetcher.ts`, cron summary, and `scripts/usage-backfill.ts` to track constraint vs manual dedupe usage; structured logs now emit `persistence` breakdowns and manual fallback windows for dashboard ingestion.
2025-10-07 – Captured synthetic manual-fallback telemetry sample (`audit/telemetry-audit/synthetic-manual-fallback.json`) and updated checklist to reflect staged diff artefacts + instrumentation readiness.
2025-10-07 – Parsed staging diff (`audit/telemetry-audit/2025-10-07T22-44-28Z-staging.json`) and published `audit/telemetry-audit/missing-windows-summary-2025-10-07.md` highlighting 31 real missing windows (project `proj_MhIbP1DyoTSqH6k2DtXVKvvV`, keys `key_mPAw5OyZbONR4dAL` / `key_NF7ZLeXYAXECwqv7`) plus 15 zero-token blank rows; CSV audit confirmed blank rows lack project/api/user metadata and can be filtered ahead of future diffs, leaving the project-specific gaps as the primary focus.
2025-10-08 – Logged gap `GAP-2025-10-07-DAILY-USAGE-PARITY` in `memorybank/context_gaps_log.md` and scheduled quarterly memory-bank sweep to reconcile progress notes with `/audit` artefacts.
2025-10-08 – Added daily usage schema preflight guard in `src/lib/usage-fetcher.ts`, emitting `SCHEMA_MISSING` issues when migration `0003_usage_event_windows.sql` is absent; updated runbook `audit/migration-prechecks/0003_usage_event_windows.md` with schema verification step.
2025-10-08 – Filtered blank metadata rows inside `scripts/usage-telemetry-diff.ts` and documented the change in `memorybank/daily_usage_alignment_plan.md`; awaiting post-migration diff rerun to verify missing window count drops.
2025-10-08 – Hardened admin pagination sanitization (`sanitizeAdminNextPageUrl`) and cron secret guard (rejecting placeholder values) with regression coverage in `tests/usageFetcherSecurity.test.ts` and status updates in `memorybank/security_audit_report.md`.
2025-10-08 – Attempted schema preflight (`ENABLE_DAILY_USAGE_WINDOWS=true pnpm exec tsx scripts/usage-backfill.ts --days=1 --chunk-days=1 --label verify-schema --dry-run`) but sandbox denied tsx IPC socket creation; staging verification remains pending until command can run against Neon.
2025-10-08 – Reran telemetry diff via bundled script (`node tmp/usage-telemetry-diff.mjs --csv openAI-data/completions_usage_2025-09-01_2025-10-01.csv --skip-db`) confirming 46 CSV windows awaiting DB backfill; diff stored at `tmp/telemetry-diff-skipdb.json`.
2025-10-08 – Outlined cron secret validation approach (expect 503 when `CRON_SECRET` unset and 401 for `Bearer undefined`), pending execution in an environment with Next runtime access.
2025-10-08 – Ran verify-schema backfill check (`ENABLE_DAILY_USAGE_WINDOWS=true pnpm exec tsx scripts/usage-backfill.ts --days 1 --chunk-days 1 --label verify-schema --start 2025-09-01 --end 2025-09-01`) via direnv/NODE_ENV=production; ingestion completed but logged `usage_admin_bucket_idx` metadata missing → manual fallback used.
2025-10-08 – Applied `pnpm drizzle-kit push` against staging (NODE_ENV=production) and captured `\d usage_events` schema dump; confirmed window_start/window_end columns and unique index present in staging.
2025-10-08 – Executed staging backfill (`pnpm usage:backfill --start 2025-09-01 --end 2025-10-01 --chunk-days 3 --label staging-repair`) with manual fallback counters captured in `audit/backfill-rehearsal/2025-10-08-staging-repair.log`; totals show 31 windows processed, 16 manual fallback updates, zero constraint inserts.
2025-10-08 – Ran staging telemetry diff (`node tmp/usage-telemetry-diff.mjs --output audit/telemetry-audit/latest-staging.json`) post-backfill; still reports 46 windows missing in DB (project `proj_MhIbP1DyoTSqH6k2DtXVKvvV`) and now 16 extra DB rows not present in CSV.
2025-10-08 – Added admin usage `group_by` parameters (`project_id,user_id,api_key_id,model,batch`); debug capture stored at `audit/backfill-rehearsal/2025-10-08-debug-groupby.log` shows OpenAI responses now include project/user/api key metadata.
2025-10-08 – Staging backfill rerun (`audit/backfill-rehearsal/2025-10-08-staging-groupby-v2.log`) inserted metadata-rich rows (16 windows now have non-null project/api key/user columns) while constraint upsert still falls back due to expression-based index.
2025-10-08 – Latest telemetry diff (`audit/telemetry-audit/latest-staging.json`) continues to flag 46 missing windows because OpenAI admin responses omit `service_tier` values even with grouping; DB-only rows (48) reflect historical null-metadata buckets that need cleanup.
2025-10-08 – Confirmed via direct admin API sample (`scripts/admin-usage-sample.ts`, output in `audit/telemetry-audit/admin-usage-2025-09-10.json`) that `service_tier` returns null even when `group_by` is set; updated parity strategy to ignore service tier and skip CSV/DB rows without project/api key/user metadata.
2025-10-08 – Re-ran staging backfill (`audit/backfill-rehearsal/2025-10-08-staging-post-servicetier.log`) and bundled telemetry diff (`tmp/usage-telemetry-diff.mjs`); parity now reports zero missing or mismatched windows (`audit/telemetry-audit/latest-staging.json`).
2025-10-08 – Purged legacy blank metadata rows with SQL script (`tmp/cleanup_usage_events.sql`, DELETE 16) and tightened telemetry diff to skip records lacking project/api key/user metadata.
2025-10-08 – Updated telemetry diff key to ignore `service_tier` and reran staging regression; missing counts remain at 46 (CSV) / 32 (DB) indicating OpenAI API still omits specific windows despite enriched metadata.
Next: Clean legacy `usage_events` rows lacking metadata, evaluate strategies for service tier parity (API limitation vs derived mapping), and rerun staging diff to verify gaps close.
2025-10-09 – Completed Step 2 audit for Anthropic integration (coupling inventory, schema review, compatibility matrix) with artefact `audit/provider-coupling-analysis.md`.
