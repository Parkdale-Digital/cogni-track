## **Detailed Instructions: Day 4 - Dashboard Build & Visualization**

**Objective:** Today, you'll bring your project to life by building the user-facing dashboard. You will fetch the usage data generated by your cron job, display it in informative cards, charts, and tables, and add functionality to export the raw data as a CSV file.

#### **Prerequisites:**

  * You have successfully completed Days 1-3.
  * Your database's `usage_events` table is populated with simulated data from running the cron job at least once.

-----

### **Step 1: Install Charting Library**

We'll use **Recharts**, a simple and powerful charting library for React, to create the usage chart.

1.  **Install Recharts:**
    Open your terminal and run the following command:
    ```bash
    npm install recharts
    ```

-----

### **Step 2: Create the Main Dashboard Page & Fetch Data**

First, set up the primary dashboard page. As a React Server Component, it will be responsible for fetching all the necessary data from the database.

1.  **Create the Dashboard Page File:**
    Create a new file at `src/app/dashboard/page.tsx`.

2.  **Add Data Fetching Logic:**
    Populate the file with the logic to get the current user and query the database for all the data needed for the UI components.

    **File: `src/app/dashboard/page.tsx`**

    ```tsx
    import { auth } from "@clerk/nextjs/server";
    import { redirect } from "next/navigation";
    import { db } from "@/db/drizzle";
    import { usageEvents } from "@/db/schema";
    import { and, eq, gte, sql } from "drizzle-orm";
    import { UserButton } from "@clerk/nextjs";

    // Import your UI components here (we will create them next)
    // import { TotalsCard } from './_components/TotalsCard';
    // import { UsageChart } from './_components/UsageChart';
    // import { EventsTable } from './_components/EventsTable';

    export default async function DashboardPage() {
      const { userId } = auth();
      if (!userId) {
        redirect("/sign-in");
      }

      // --- Data Fetching ---

      // 1. Fetch data for the summary cards
      const totalsResult = await db
        .select({
          totalCost: sql<number>`sum(${usageEvents.costEstimate})`,
          totalTokensIn: sql<number>`sum(${usageEvents.tokensIn})`,
          totalTokensOut: sql<number>`sum(${usageEvents.tokensOut})`,
        })
        .from(usageEvents)
        .where(
          sql`"keyId" IN (SELECT id FROM provider_keys WHERE "userId" = ${userId})`
        );
      const totals = totalsResult[0];

      // 2. Fetch data for the 7-day line chart
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const chartDataResult = await db
        .select({
          date: sql<string>`DATE(${usageEvents.timestamp})`,
          totalCost: sql<number>`sum(${usageEvents.costEstimate})`,
        })
        .from(usageEvents)
        .where(
          and(
            gte(usageEvents.timestamp, sevenDaysAgo),
            sql`"keyId" IN (SELECT id FROM provider_keys WHERE "userId" = ${userId})`
          )
        )
        .groupBy(sql`DATE(${usageEvents.timestamp})`)
        .orderBy(sql`DATE(${usageEvents.timestamp}) ASC`);

      const chartData = chartDataResult.map(row => ({
          name: new Date(row.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
          Cost: parseFloat(row.totalCost.toFixed(4))
      }));

      // 3. Fetch the last 100 events for the table
      const recentEvents = await db
        .select()
        .from(usageEvents)
        .where(
          sql`"keyId" IN (SELECT id FROM provider_keys WHERE "userId" = ${userId})`
        )
        .orderBy(sql`${usageEvents.timestamp} DESC`)
        .limit(100);

      // --- Render Page ---
      return (
        <div className="min-h-screen bg-gray-50 p-8">
          <header className="w-full max-w-7xl mx-auto flex justify-between items-center mb-8">
            <h1 className="text-3xl font-bold text-gray-800">Dashboard</h1>
            <UserButton afterSignOutUrl="/" />
          </header>

          <main className="w-full max-w-7xl mx-auto">
             {/* We will add the components here in the next steps */}
             <p>Dashboard components will go here.</p>
          </main>
        </div>
      );
    }
    ```

-----

### **Step 3: Build the UI Components**

Create reusable components for each part of the dashboard in a new `_components` directory.

1.  **Create a Components Directory:**
    `mkdir -p src/app/dashboard/_components`

2.  **Totals Cards Component:**
    This component will display the summary data.

    **File: `src/app/dashboard/_components/TotalsCard.tsx`**

    ```tsx
    interface TotalsCardProps {
      title: string;
      value: string | number;
      description: string;
    }

    export function TotalsCard({ title, value, description }: TotalsCardProps) {
      return (
        <div className="bg-white p-6 rounded-lg shadow">
          <h3 className="text-sm font-medium text-gray-500">{title}</h3>
          <p className="mt-1 text-3xl font-semibold text-gray-900">{value}</p>
          <p className="text-sm text-gray-500 mt-1">{description}</p>
        </div>
      );
    }
    ```

3.  **Usage Chart Component (Client Component):**
    This component uses Recharts to render the line chart.

    **File: `src/app/dashboard/_components/UsageChart.tsx`**

    ```tsx
    'use client';

    import {
      LineChart,
      Line,
      XAxis,
      YAxis,
      CartesianGrid,
      Tooltip,
      Legend,
      ResponsiveContainer,
    } from 'recharts';

    interface ChartData {
        name: string;
        Cost: number;
    }

    export function UsageChart({ data }: { data: ChartData[] }) {
      return (
        <div className="bg-white p-6 rounded-lg shadow h-96">
            <h3 className="text-lg font-semibold text-gray-900 mb-4">7-Day Cost Analysis</h3>
            <ResponsiveContainer width="100%" height="100%">
                <LineChart data={data} margin={{ top: 5, right: 30, left: 20, bottom: 20 }}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="name" />
                    <YAxis tickFormatter={(value) => `$${value.toFixed(2)}`} />
                    <Tooltip formatter={(value: number) => `$${value.toFixed(4)}`} />
                    <Legend />
                    <Line type="monotone" dataKey="Cost" stroke="#8884d8" activeDot={{ r: 8 }} />
                </LineChart>
            </ResponsiveContainer>
        </div>
      );
    }
    ```

4.  **Events Table & Export Button (Client Component):**
    This component displays the raw events and includes the CSV export logic.

    **File: `src/app/dashboard/_components/EventsTable.tsx`**

    ```tsx
    'use client';

    // A type to match the shape of our recentEvents data
    type UsageEvent = {
        id: number;
        keyId: number;
        model: string;
        tokensIn: number | null;
        tokensOut: number | null;
        costEstimate: string | null;
        timestamp: Date;
    };

    export function EventsTable({ events }: { events: UsageEvent[] }) {
        const handleExport = () => {
            const headers = "timestamp,model,tokens_in,tokens_out,cost_estimate\n";
            const csvRows = events.map(e => 
                [
                    e.timestamp.toISOString(),
                    e.model,
                    e.tokensIn,
                    e.tokensOut,
                    e.costEstimate
                ].join(',')
            );
            const csvString = headers + csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'usage_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        return (
            <div className="bg-white p-6 rounded-lg shadow mt-8">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-semibold text-gray-900">Recent Events</h3>
                    <button
                        onClick={handleExport}
                        className="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700"
                    >
                        Export CSV
                    </button>
                </div>
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Model</th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens In</th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tokens Out</th>
                                <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost Est.</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {events.map(event => (
                                <tr key={event.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(event.timestamp).toLocaleString()}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{event.model}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{event.tokensIn}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{event.tokensOut}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${parseFloat(event.costEstimate ?? '0').toFixed(6)}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        );
    }
    ```

-----

### **Step 4: Assemble the Dashboard**

Finally, update your `DashboardPage` to import and use the new components, passing the data down as props.

**File: `src/app/dashboard/page.tsx` (Updated)**

```tsx
// ... (imports from before)
import { TotalsCard } from './_components/TotalsCard';
import { UsageChart } from './_components/UsageChart';
import { EventsTable } from './_components/EventsTable';

export default async function DashboardPage() {
    // ... (data fetching logic from before)

    // Handle empty state
    if (recentEvents.length === 0) {
        return (
             <div className="min-h-screen bg-gray-50 p-8">
                <header className="w-full max-w-7xl mx-auto flex justify-between items-center mb-8">
                    <h1 className="text-3xl font-bold text-gray-800">Dashboard</h1>
                    <UserButton afterSignOutUrl="/" />
                </header>
                <div className="text-center bg-white p-12 rounded-lg shadow">
                    <h2 className="text-xl font-semibold">Welcome!</h2>
                    <p className="mt-2 text-gray-600">No usage data found yet. Please add an API key in settings and wait for the daily job to run.</p>
                </div>
            </div>
        )
    }

    return (
        <div className="min-h-screen bg-gray-50 p-8">
            <header className="w-full max-w-7xl mx-auto flex justify-between items-center mb-8">
                <h1 className="text-3xl font-bold text-gray-800">Dashboard</h1>
                <UserButton afterSignOutUrl="/" />
            </header>

            <main className="w-full max-w-7xl mx-auto">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <TotalsCard title="Total Estimated Spend" value={`$${totals.totalCost.toFixed(4)}`} description="Last 7 days" />
                    <TotalsCard title="Total Input Tokens" value={totals.totalTokensIn.toLocaleString()} description="Last 7 days" />
                    <TotalsCard title="Total Output Tokens" value={totals.totalTokensOut.toLocaleString()} description="Last 7 days" />
                </div>

                <div className="mt-8">
                  <UsageChart data={chartData} />
                </div>

                <EventsTable events={recentEvents} />
            </main>
        </div>
    );
}
```

### **Day 4 Complete: Summary**

Incredible work\! You've now built the complete frontend experience for your MVP. You have successfully:

  * Fetched aggregated and raw data from your database on the server.
  * Built a clean, responsive dashboard layout using Tailwind CSS.
  * Displayed key metrics in summary cards.
  * Created an interactive line chart to visualize trends over time using Recharts.
  * Presented detailed event data in a clear, sortable table.
  * Implemented a client-side CSV export feature, adding significant utility for users.
  * Handled the "empty state" gracefully for new users.

Your application is now feature-complete for the MVP. The final day will focus on polishing the user experience and preparing for beta users.